<opal-lib-govuk-heading-with-caption captionText="Create account" headingText="Business unit and defendant type">
</opal-lib-govuk-heading-with-caption>
<opal-lib-govuk-error-summary
  [errors]="formErrorSummaryMessage"
  (errorClick)="scrollTo($event)"
></opal-lib-govuk-error-summary>
<form (submit)="handleFormSubmit($event)">
  @if (autoCompleteItems.length === 1) {
    <p>The account will be created in {{ autoCompleteItems[0].name }}</p>
  } @else {
    <opal-lib-alphagov-accessible-autocomplete
      [control]="form.get('fm_create_account_business_unit_id')"
      labelText="Business unit"
      labelClasses="govuk-fieldset__legend--m"
      inputId="fm_create_account_business_unit_id"
      inputName="fm_create_account_business_unit_id"
      label="Search for a user"
      hintText="Enter area where the account is to be created"
      [autoCompleteItems]="autoCompleteItems"
      [errors]="formControlErrorMessages['fm_create_account_business_unit_id']"
      [tabIndex]="0"
    ></opal-lib-alphagov-accessible-autocomplete>
  }

  <opal-lib-govuk-radio
    fieldSetId="fm_create_account_account_type"
    legendText="Account type"
    legendClasses="govuk-fieldset__legend--m"
    [errors]="formControlErrorMessages['fm_create_account_account_type']"
  >
    @for (accountType of accountTypes; track accountType.key) {
      <div
        opal-lib-govuk-radios-item
        [labelText]="accountType.value"
        [inputId]="'fm_create_account_account_type-' + accountType.key"
        inputName="fm_create_account_account_type"
        [inputValue]="accountType.value"
        [ariaControls]="
          accountType.value === accountTypesKeys.Fine
            ? fineDefendantConditionalId
            : accountType.value === accountTypesKeys['Fixed Penalty']
              ? fixedPenaltyDefendantConditionalId
              : ''
        "
        [control]="form.get('fm_create_account_account_type')"
        [inputValueHint]="accountType.value === accountTypesKeys['Conditional Caution'] ? 'Adult or youth only' : ''"
      ></div>

      @if (accountType.value === accountTypesKeys.Fine) {
        <opal-lib-govuk-radios-conditional [conditionalId]="fineDefendantConditionalId">
          <ng-container
            *ngTemplateOutlet="
              defendantTypesRadioOptions;
              context: { defendantTypes: fineDefendantTypes, controlName: 'fm_create_account_fine_defendant_type' }
            "
          ></ng-container>
        </opal-lib-govuk-radios-conditional>
      }
      @if (accountType.value === accountTypesKeys['Fixed Penalty']) {
        <opal-lib-govuk-radios-conditional [conditionalId]="fixedPenaltyDefendantConditionalId">
          <ng-container
            *ngTemplateOutlet="
              defendantTypesRadioOptions;
              context: {
                defendantTypes: fixedPenaltyDefendantTypes,
                controlName: 'fm_create_account_fixed_penalty_defendant_type',
              }
            "
          ></ng-container>
        </opal-lib-govuk-radios-conditional>
      }
    }
  </opal-lib-govuk-radio>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <opal-lib-govuk-button buttonId="submitForm" type="submit">Continue</opal-lib-govuk-button>
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <opal-lib-govuk-cancel-link
        (linkClickEvent)="handleRoute(routingPath.children.dashboard, { nonRelative: true })"
      ></opal-lib-govuk-cancel-link>
    </div>
  </div>
</form>

<ng-template #defendantTypesRadioOptions let-defendantTypes="defendantTypes" let-controlName="controlName">
  <opal-lib-govuk-radio
    [fieldSetId]="controlName"
    legendText="Defendant type"
    legendClasses="govuk-fieldset__legend--m"
    legendHint="If sole trader, choose 'Adult or youth only'"
    [errors]="formControlErrorMessages[controlName]"
  >
    @for (defendantType of defendantTypes; track defendantType.key) {
      <div
        opal-lib-govuk-radios-item
        [labelText]="defendantType.value"
        [inputId]="controlName + '-' + defendantType.key"
        [inputName]="controlName"
        [inputValue]="defendantType.value"
        [control]="form.get(controlName)"
      ></div>
    }
  </opal-lib-govuk-radio>
</ng-template>
