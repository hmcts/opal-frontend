<h1 class="govuk-heading-l">Payment terms</h1>
<app-govuk-error-summary [errors]="formErrorSummaryMessage" (errorClick)="scrollTo($event)"></app-govuk-error-summary>
<form (submit)="handleFormSubmit($event)" [formGroup]="form">
  @if (accessCollectionOrder) {
    <app-govuk-radio
      [fieldSetId]="paymentTermsHasCollectionOrder.controlName"
      legendText="Has a collection order been made?"
      legendClasses="govuk-fieldset__legend--s"
      [errors]="formControlErrorMessages[paymentTermsHasCollectionOrder.controlName]"
    >
      <div
        app-govuk-radios-item
        labelText="Yes"
        inputId="yes"
        [inputName]="paymentTermsHasCollectionOrder.controlName"
        inputValue="yes"
        [control]="form.controls[paymentTermsHasCollectionOrder.controlName]"
      ></div>
      @if (form.get(paymentTermsHasCollectionOrder.controlName)!.value !== null) {
        @if (form.get(paymentTermsHasCollectionOrder.controlName)!.value === 'yes') {
          <div app-govuk-radios-conditional [conditionalId]="paymentTermsHasCollectionOrder.controlName">
            <div class="govuk-form-group">
              <app-moj-date-picker
                labelText="Date of collection order"
                labelClasses="govuk-label--s"
                [inputId]="paymentTermsCollectionOrderDate.controlName"
                [inputName]="paymentTermsCollectionOrderDate.controlName"
                inputClasses="govuk-input--width-10"
                hintText="For example, 31/01/2023"
                [maxDate]="today"
                [control]="form.controls[paymentTermsCollectionOrderDate.controlName]"
                [errors]="formControlErrorMessages[paymentTermsCollectionOrderDate.controlName]"
                (dateChange)="setInputValue($event, paymentTermsCollectionOrderDate.controlName)"
              ></app-moj-date-picker>
            </div>
          </div>
        }
      }

      <div
        app-govuk-radios-item
        labelText="No"
        inputId="no"
        [inputName]="paymentTermsHasCollectionOrder.controlName"
        inputValue="no"
        [control]="form.controls[paymentTermsHasCollectionOrder.controlName]"
      ></div>
      @if (form.get(paymentTermsHasCollectionOrder.controlName)!.value !== null) {
        @if (form.get(paymentTermsHasCollectionOrder.controlName)!.value === 'no') {
          @if (permissions[permissionsMap.collectionOrder] !== false) {
            <div app-govuk-radios-conditional [conditionalId]="paymentTermsHasCollectionOrder.controlName">
              <div class="govuk-form-group">
                <app-govuk-checkboxes-item
                  [inputId]="paymentTermsMakeCollectionOrderToday.controlName"
                  [inputName]="paymentTermsMakeCollectionOrderToday.controlName"
                  labelText="Make collection order today"
                  [control]="form.controls[paymentTermsMakeCollectionOrderToday.controlName]"
                ></app-govuk-checkboxes-item>
              </div>
            </div>
          }
        }
      }
    </app-govuk-radio>
  }
  <app-govuk-radio
    [fieldSetId]="paymentTermsPaymentTerms.controlName"
    legendText="Select payment terms"
    legendClasses="govuk-fieldset__legend--s"
    [errors]="formControlErrorMessages[paymentTermsPaymentTerms.controlName]"
  >
    @for (paymentTerm of paymentTerms; track paymentTerm.key) {
      <div
        app-govuk-radios-item
        [labelText]="paymentTerm.value"
        [inputId]="paymentTerm.key"
        [inputName]="paymentTermsPaymentTerms.controlName"
        [inputValue]="paymentTerm.key"
        [control]="form.controls[paymentTermsPaymentTerms.controlName]"
      ></div>

      @switch (paymentTerm.key) {
        @case ('payInFull') {
          @if (form.get(paymentTermsPaymentTerms.controlName)!.value === paymentTerm.key) {
            <div app-govuk-radios-conditional [conditionalId]="paymentTermsPaymentTerms.controlName">
              <div class="govuk-form-group">
                <app-moj-date-picker
                  labelText="Enter pay by date"
                  labelClasses="govuk-label--s"
                  [inputId]="paymentTermsPayByDate.controlName"
                  [inputName]="paymentTermsPayByDate.controlName"
                  inputClasses="govuk-input--width-10"
                  hintText="For example, 31/01/2023"
                  [control]="form.controls[paymentTermsPayByDate.controlName]"
                  [errors]="formControlErrorMessages[paymentTermsPayByDate.controlName]"
                  (dateChange)="setInputValue($event, paymentTermsPayByDate.controlName)"
                ></app-moj-date-picker>
                @if (dateInPast) {
                  <ng-container
                    *ngTemplateOutlet="dateInPastTemplate; context: { $implicit: 'Pay by date' }"
                  ></ng-container>
                }
                @if (dateInFuture) {
                  <ng-container
                    *ngTemplateOutlet="dateInFutureTemplate; context: { $implicit: 'Pay by date' }"
                  ></ng-container>
                }
              </div>
            </div>
          }
        }
        @case ('instalmentsOnly') {
          @if (form.get(paymentTermsPaymentTerms.controlName)!.value === paymentTerm.key) {
            <div app-govuk-radios-conditional [conditionalId]="paymentTermsPaymentTerms.controlName">
              <ng-container *ngTemplateOutlet="instalmentsFrequencyStartDate"></ng-container>
            </div>
          }
        }
        @case ('lumpSumPlusInstalments') {
          @if (form.get(paymentTermsPaymentTerms.controlName)!.value === paymentTerm.key) {
            <div app-govuk-radios-conditional [conditionalId]="paymentTermsPaymentTerms.controlName">
              <div class="govuk-form-group">
                <app-govuk-text-input-prefix-suffix
                  labelText="Lump sum"
                  labelClasses="govuk-label--s"
                  [inputId]="paymentTermsLumpSum.controlName"
                  [inputName]="paymentTermsLumpSum.controlName"
                  inputClasses="govuk-input--width-5"
                  prefixText="£"
                  [control]="form.controls[paymentTermsLumpSum.controlName]"
                  [errors]="formControlErrorMessages[paymentTermsLumpSum.controlName]"
                  [forceTwoDecimalPoints]="true"
                >
                </app-govuk-text-input-prefix-suffix>
              </div>
              <ng-container *ngTemplateOutlet="instalmentsFrequencyStartDate"></ng-container>
            </div>
          }
        }
      }
    }
  </app-govuk-radio>
  @if (defendantType !== 'company') {
    <div
      app-govuk-checkboxes-item
      labelText="Request payment card"
      [inputId]="paymentTermsRequestCardPayment.controlName"
      [inputName]="paymentTermsRequestCardPayment.controlName"
      [control]="form.controls[paymentTermsRequestCardPayment.controlName]"
    ></div>
  }
  @if (accessDefaultDates) {
    <app-govuk-checkboxes
      fieldSetId="daysInDefaultCheckbox"
      legendText="Days in default"
      legendClasses="govuk-fieldset__legend--s"
    >
      <div
        app-govuk-checkboxes-item
        labelText="There are days in default"
        [inputId]="paymentTermsHasDaysInDefault.controlName"
        [inputName]="paymentTermsHasDaysInDefault.controlName"
        [control]="form.controls[paymentTermsHasDaysInDefault.controlName]"
      ></div>

      @if (form.get(paymentTermsHasDaysInDefault.controlName)?.value) {
        <div app-govuk-checkboxes-conditional [conditionalId]="paymentTermsHasDaysInDefault.controlName">
          <div class="govuk-form-group">
            <app-moj-date-picker
              labelText="Date days in default were imposed"
              labelClasses="govuk-label--s"
              [inputId]="paymentTermsDaysInDefaultDate.controlName"
              [inputName]="paymentTermsDaysInDefaultDate.controlName"
              inputClasses="govuk-input--width-10"
              hintText="This should be whichever date is most recent - the sentencing date or the date of the suspended committal order."
              [maxDate]="yesterday"
              [control]="form.controls[paymentTermsDaysInDefaultDate.controlName]"
              [errors]="formControlErrorMessages[paymentTermsDaysInDefaultDate.controlName]"
              (dateChange)="setInputValue($event, paymentTermsDaysInDefaultDate.controlName)"
            ></app-moj-date-picker>
          </div>
          <div class="govuk-form-group">
            <app-govuk-text-input-prefix-suffix
              labelText="Enter days in default"
              labelClasses="govuk-label--s"
              [inputId]="paymentTermsDaysInDefault.controlName"
              [inputName]="paymentTermsDaysInDefault.controlName"
              inputClasses="govuk-input--width-5"
              suffixText="days"
              [control]="form.controls[paymentTermsDaysInDefault.controlName]"
              [errors]="formControlErrorMessages[paymentTermsDaysInDefault.controlName]"
            ></app-govuk-text-input-prefix-suffix>
          </div>
          <div class="govuk-form-group">
            <app-fines-mac-default-days
              [date]="form.controls[paymentTermsDaysInDefaultDate.controlName].value"
            ></app-fines-mac-default-days>
          </div>
        </div>
      }
    </app-govuk-checkboxes>
  }
  <app-govuk-checkboxes
    fieldSetId="enforcementActions"
    legendText="Enforcement action"
    legendClasses="govuk-fieldset__legend--s"
  >
    @if (defendantType === 'company') {
      <div
        app-govuk-checkboxes-item
        labelText="Hold enforcement on account (NOENF)"
        [inputId]="paymentTermsHoldEnforcementOnAccount.controlName"
        [inputName]="paymentTermsHoldEnforcementOnAccount.controlName"
        [control]="form.controls[paymentTermsHoldEnforcementOnAccount.controlName]"
      ></div>
      <div *ngIf="form.get(paymentTermsHoldEnforcementOnAccount.controlName)?.value">
        <div app-govuk-checkboxes-conditional [conditionalId]="paymentTermsHoldEnforcementOnAccount.controlName">
          <app-govuk-text-area
            labelText="Reason account is on NOENF"
            labelClasses="govuk-label--s"
            [inputId]="paymentTermsReasonAccountIsOnNoEnf.controlName"
            [inputName]="paymentTermsReasonAccountIsOnNoEnf.controlName"
            inputClasses="govuk-!-width-two-thirds"
            [control]="form.controls[paymentTermsReasonAccountIsOnNoEnf.controlName]"
            [errors]="formControlErrorMessages[paymentTermsReasonAccountIsOnNoEnf.controlName]"
            [rows]="1"
            [maxCharacterLimit]="28"
            [characterCountEnabled]="true"
          ></app-govuk-text-area>
        </div>
      </div>
    } @else {
      <div
        app-govuk-checkboxes-item
        labelText="Add enforcement action"
        [inputId]="paymentTermsAddEnforcementAction.controlName"
        [inputName]="paymentTermsAddEnforcementAction.controlName"
        [control]="form.controls[paymentTermsAddEnforcementAction.controlName]"
      ></div>
      @if (form.get(paymentTermsAddEnforcementAction.controlName)!.value !== null) {
        @if (form.get(paymentTermsAddEnforcementAction.controlName)?.value === true) {
          <div app-govuk-checkboxes-conditional [conditionalId]="paymentTermsAddEnforcementAction.controlName">
            <app-govuk-radio
              [fieldSetId]="paymentTermsEnforcementActions.controlName"
              legendClasses="govuk-fieldset__legend--s"
              [errors]="formControlErrorMessages[paymentTermsEnforcementActions.controlName]"
            >
              @for (enforcementAction of enforcementActions; track enforcementAction.key) {
                <div
                  app-govuk-radios-item
                  [labelText]="enforcementAction.value"
                  [inputId]="enforcementAction.key"
                  [inputName]="paymentTermsEnforcementActions.controlName"
                  [inputValue]="enforcementAction.key"
                  [control]="form.controls[paymentTermsEnforcementActions.controlName]"
                ></div>

                @if (enforcementAction.key === 'defendantIsInCustody') {
                  @if (form.get(paymentTermsEnforcementActions.controlName)!.value === enforcementAction.key) {
                    <div app-govuk-radios-conditional [conditionalId]="paymentTermsEnforcementActions.controlName">
                      <div class="govuk-form-group">
                        <app-moj-date-picker
                          labelText="Earliest release date (EDR)"
                          labelClasses="govuk-label--s"
                          [inputId]="paymentTermsEarliestReleaseDate.controlName"
                          [inputName]="paymentTermsEarliestReleaseDate.controlName"
                          inputClasses="govuk-input--width-10"
                          [maxDate]="yesterday"
                          [control]="form.controls[paymentTermsEarliestReleaseDate.controlName]"
                          [errors]="formControlErrorMessages[paymentTermsEarliestReleaseDate.controlName]"
                          (dateChange)="setInputValue($event, paymentTermsEarliestReleaseDate.controlName)"
                        ></app-moj-date-picker>
                      </div>
                      <div class="govuk-form-group">
                        <app-govuk-text-area
                          labelText="Prison and prison number"
                          labelClasses="govuk-label--s"
                          hintText="Held as enforcement comment"
                          [inputId]="paymentTermsPrisonAndPrisonNumber.controlName"
                          [inputName]="paymentTermsPrisonAndPrisonNumber.controlName"
                          inputClasses="govuk-!-width-two-thirds"
                          [control]="form.controls[paymentTermsPrisonAndPrisonNumber.controlName]"
                          [errors]="formControlErrorMessages[paymentTermsPrisonAndPrisonNumber.controlName]"
                          [rows]="1"
                          [maxCharacterLimit]="28"
                          [characterCountEnabled]="true"
                        ></app-govuk-text-area>
                      </div>
                    </div>
                  }
                } @else {
                  @if (form.get(paymentTermsEnforcementActions.controlName)!.value === enforcementAction.key) {
                    <div app-govuk-radios-conditional [conditionalId]="paymentTermsEnforcementActions.controlName">
                      <app-govuk-text-area
                        labelText="Reason account is on NOENF"
                        labelClasses="govuk-label--s"
                        [inputId]="paymentTermsReasonAccountIsOnNoEnf.controlName"
                        [inputName]="paymentTermsReasonAccountIsOnNoEnf.controlName"
                        inputClasses="govuk-!-width-two-thirds"
                        [control]="form.controls[paymentTermsReasonAccountIsOnNoEnf.controlName]"
                        [errors]="formControlErrorMessages[paymentTermsReasonAccountIsOnNoEnf.controlName]"
                        [rows]="1"
                        [maxCharacterLimit]="28"
                        [characterCountEnabled]="true"
                      ></app-govuk-text-area>
                    </div>
                  }
                }
              }
            </app-govuk-radio>
          </div>
        }
      }
    }
  </app-govuk-checkboxes>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <app-govuk-button buttonId="submitForm" type="submit">Return to account details</app-govuk-button>
      <app-govuk-button
        buttonId="submitForm"
        type="submit"
        buttonClasses="nested-flow govuk-button--secondary govuk-!-margin-left-3"
      >
        Add account comments and notes
      </app-govuk-button>
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <app-govuk-cancel-link
        (linkClickEvent)="handleRoute(fineMacRoutingPaths.children.accountDetails)"
      ></app-govuk-cancel-link>
    </div>
  </div>
</form>

<ng-template #instalmentsFrequencyStartDate>
  <div class="govuk-form-group">
    <app-govuk-text-input-prefix-suffix
      labelText="Instalment"
      labelClasses="govuk-label--s"
      [inputId]="paymentTermsInstalment.controlName"
      [inputName]="paymentTermsInstalment.controlName"
      inputClasses="govuk-input--width-5"
      prefixText="£"
      [control]="form.controls[paymentTermsInstalment.controlName]"
      [errors]="formControlErrorMessages[paymentTermsInstalment.controlName]"
      [forceTwoDecimalPoints]="true"
    >
    </app-govuk-text-input-prefix-suffix>
  </div>
  <div class="govuk-form-group">
    <app-govuk-radio
      fieldSetId="frequency"
      legendText="Frequency"
      legendClasses="govuk-fieldset__legend--s"
      [errors]="formControlErrorMessages[paymentTermsFrequency.controlName]"
    >
      @for (frequency of frequencyOptions; track frequency.key) {
        <div
          app-govuk-radios-item
          [labelText]="frequency.value"
          [inputId]="frequency.key"
          [inputName]="paymentTermsFrequency.controlName"
          [inputValue]="frequency.key"
          [control]="form.controls[paymentTermsFrequency.controlName]"
        ></div>
      }
    </app-govuk-radio>
  </div>
  <div class="govuk-form-group">
    <app-moj-date-picker
      labelText="Start date"
      labelClasses="govuk-label--s"
      [inputId]="paymentTermsStartDate.controlName"
      [inputName]="paymentTermsStartDate.controlName"
      inputClasses="govuk-input--width-10"
      hintText="For example, 31/01/2023"
      [maxDate]="yesterday"
      [control]="form.controls[paymentTermsStartDate.controlName]"
      [errors]="formControlErrorMessages[paymentTermsStartDate.controlName]"
      (dateChange)="setInputValue($event, paymentTermsStartDate.controlName)"
    ></app-moj-date-picker>
    @if (dateInPast) {
      <ng-container *ngTemplateOutlet="dateInPastTemplate; context: { $implicit: 'Start date' }"></ng-container>
    }
    @if (dateInFuture) {
      <ng-container *ngTemplateOutlet="dateInFutureTemplate; context: { $implicit: 'Start date' }"></ng-container>
    }
  </div>
</ng-template>
<ng-template #dateInPastTemplate let-fieldName>
  <app-moj-ticket-panel sectionClasses="moj-ticket-panel__content--orange">
    <strong>{{ fieldName }} is in the past</strong>
    <p>You can continue with date in the past or change</p>
  </app-moj-ticket-panel>
</ng-template>
<ng-template #dateInFutureTemplate let-fieldName>
  <app-moj-ticket-panel sectionClasses="moj-ticket-panel__content--orange">
    <strong>{{ fieldName }} is more than 3 years in the future</strong>
    <p>You can continue with date in the past or change</p>
  </app-moj-ticket-panel>
</ng-template>
